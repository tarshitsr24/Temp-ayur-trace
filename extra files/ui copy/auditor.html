<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auditor Dashboard - AyurTrace</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <header>
    <div class="logo">
      <svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
        <path
          d="M163.4,191.8c-1.3,0.1-2.6-0.1-3.9-0.5c-35.4-11.2-50-51.7-41.5-85.1c1-4,3.8-7.3,7.6-9.2C130,95,133.2,95,136.2,96.4c1.9,0.9,3.6,2.2,4.9,3.9c12.2,16.2,12,39.2-0.5,55.1c-1.2,1.5-2.7,2.8-4.4,3.9c-14.4,9-33.3,7.5-46.1-4.2c-1.8-1.6-3.2-3.6-4.2-5.7c-1.1-2.4-1.6-5-1.5-7.6c0.2-19.1,13.7-36.1,32.2-41.2c2.4-0.7,4.9-0.7,7.3,0.1c2.8,0.9,5.3,2.6,7.2,4.9l2.2-3.8c-2.3-2.8-5.3-4.9-8.7-6c-4.4-1.4-9.2-1.5-13.8-0.2c-23.1,6.5-39.7,28.6-40,52.3c-0.4,28.2,16,54.7,43,64.3c15.2,5.4,31.4,4.2,45.9-3.2c4.4-2.2,8.2-5.4,11.3-9.3l-2.1-3.8C171,189.5,167.3,191.4,163.4,191.8z" />
        <path
          d="M190.5,110.1c-1.3-0.1-2.6,0.1-3.9,0.5c-35.4,11.2-50,51.7-41.5,85.1c1,4,3.8,7.3,7.6,9.2c4.4,2.1,9.4,2.1,13.9-0.2c3.8-1.9,6.9-4.9,9-8.5c12.2-21.1,5-48.4-12.8-62.3c-1.2-0.9-2.5-1.7-3.9-2.3c-14.4-6.3-31.1-3.1-42.3,8.5c-1.8,1.8-3.2,4-4,6.4c-1.1,3.1-1.5,6.4-1.1,9.7c1.3,19.1,16.6,34.7,35.6,38.2c2.4,0.4,4.8,0.3,7.2-0.3c2.8-0.7,5.4-2.1,7.6-4.1l2.2,3.8c-2.7,2.5-5.9,4.2-9.4,5.1c-4.4,1.1-9,0.9-13.3-0.5c-23-7.5-38.3-29.9-37.1-53.6c1.1-24.1,20.2-44.4,44-48.3c15.2-2.5,30.3,1.9,41.2,11.4c4.4,3.8,7.4,8.9,8.7,14.5l-2.1,0.5C193.8,111.4,192.2,110.5,190.5,110.1z" />
      </svg>
      <h1>AyurTrace</h1>
    </div>
    <nav>
      <a href="#" class="active"><i class="fas fa-home"></i> Dashboard</a>
      <a href="#">Logout</a>
    </nav>
  </header>

  <main class="container">
    <div class="dashboard-header">
      <h2><i class="fas fa-home"></i> Auditor Dashboard üïµÔ∏è</h2>
      <p>Inspect collected batches and approve or reject them on the blockchain.</p>
    </div>

    <div class="dashboard-content">
      <div class="card">
        <h3 class="card-header">Inspect Batch</h3>
        <form id="inspect-form">
          <div class="form-group">
            <label for="batch-id">Scan/Enter Batch ID</label>
            <input type="text" id="batch-id" placeholder="e.g., FR123-20250908" required>
          </div>
          <div class="form-group">
            <label for="inspection-date">Inspection Date</label>
            <input type="date" id="inspection-date" required>
          </div>
          <div class="form-group">
            <label for="status">Status</label>
            <select id="status">
              <option value="Approved">‚úÖ Approved</option>
              <option value="Rejected">‚ùå Rejected</option>
            </select>
          </div>
          <div class="form-group">
            <label for="notes">Notes / Remarks</label>
            <textarea id="notes" placeholder="e.g., Fresh, no pesticides detected..."></textarea>
          </div>
          <button type="submit" class="submit-btn" id="submit-btn">Submit + Update Blockchain Record</button>
          <p id="status-message" class="error-message" style="text-align: center;"></p>
        </form>
      </div>

      <div class="card">
        <h3 class="card-header">Inspection History</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Batch ID</th>
                <th>Status</th>
                <th>Auditor Notes</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="history-table-body">
              <tr class="placeholder">
                <td colspan="4">No batches inspected yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const contractAddress = "YOUR_AUDITOR_CONTRACT_ADDRESS";
      const contractABI = [ /* PASTE_YOUR_AUDITOR_CONTRACT_ABI_HERE */];

      const form = document.getElementById('inspect-form');
      const submitBtn = document.getElementById('submit-btn');
      const statusMessage = document.getElementById('status-message');
      const historyTableBody = document.getElementById('history-table-body');

      let contract, signer;

      async function init() {
        if (typeof window.ethereum === 'undefined') {
          statusMessage.innerText = "Please install MetaMask!";
          submitBtn.disabled = true;
          return;
        }

        try {
          const provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
          contract = new ethers.Contract(contractAddress, contractABI, signer);
          document.getElementById('inspection-date').value = new Date().toISOString().split('T')[0];

        } catch (error) {
          console.error("Initialization failed:", error);
          statusMessage.innerText = "Could not connect to wallet.";
          submitBtn.disabled = true;
        }
      }

      async function handleFormSubmit(event) {
        event.preventDefault();
        if (!contract || !signer) {
          statusMessage.innerText = "Please connect wallet first.";
          return;
        }

        submitBtn.disabled = true;
        statusMessage.innerText = "Processing... Please confirm in MetaMask.";

        const batchId = document.getElementById('batch-id').value;
        const result = document.getElementById('status').value;
        const notes = document.getElementById('notes').value || 'N/A';
        const inspectionDate = new Date(document.getElementById('inspection-date').value).toLocaleDateString('en-GB');

        try {
          const auditorId = await signer.getAddress();
          const tx = await contract.addInspection(batchId, auditorId, result, notes);

          statusMessage.innerText = "Transaction sent... waiting for confirmation.";
          await tx.wait();

          statusMessage.innerText = `Success! Batch ${batchId} has been ${result}.`;
          addInspectionToHistory({ batchId, result, notes, date: inspectionDate });
          form.reset();
          document.getElementById('inspection-date').value = new Date().toISOString().split('T')[0];

        } catch (error) {
          console.error("Transaction failed:", error);
          statusMessage.innerText = "Transaction failed. Check console.";
        } finally {
          submitBtn.disabled = false;
          setTimeout(() => { statusMessage.innerText = ''; }, 5000);
        }
      }

      function addInspectionToHistory(data) {
        const placeholder = historyTableBody.querySelector('.placeholder');
        if (placeholder) {
          placeholder.style.display = 'none';
        }

        const newRow = document.createElement('tr');
        const statusClass = data.result === 'Approved' ? 'status-approved' : 'status-rejected';

        newRow.innerHTML = `
                    <td>${data.batchId}</td>
                    <td><span class="status ${statusClass}">${data.result}</span></td>
                    <td>${data.notes}</td>
                    <td>${data.date}</td>
                `;
        historyTableBody.prepend(newRow);
      }

      form.addEventListener('submit', handleFormSubmit);
      init();
    });
  </script>
</body>

</html>
