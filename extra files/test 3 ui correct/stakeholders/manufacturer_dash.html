<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manufacturer Dashboard - AyurTrace</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../theme.css">
</head>

<body>
  <header>
    <div class="logo">
      <h1><a href="../index.html" style="text-decoration: none; color: inherit;">AyurTrace</a></h1>
    </div>
    <nav>
      <a href="#" class="active"><i class="fas fa-home"></i> Dashboard</a>
      <a href="../logout.html">Logout</a>
    </nav>
  </header>

  <main class="container">
    <div class="dashboard-header">
      <h2><i class="fas fa-home"></i> Manufacturer Dashboard üè≠</h2>
      <p>Process audited batches and create final, traceable products.</p>
    </div>

    <div class="stats-grid">
      <div class="stats-card">
        <p class="value">0</p>
        <p class="label">Total Batches Processed</p>
      </div>
      <div class="stats-card">
        <p class="value">0%</p>
        <p class="label">Average Wastage</p>
      </div>
      <div class="stats-card">
        <p class="value">-</p>
        <p class="label">Top Product</p>
      </div>
    </div>

    <div class="dashboard-content">
      <div class="card">
        <h3 class="card-header">Process New Batch</h3>
        <form id="process-form">
          <div class="form-group">
            <label for="source-batch-id">Scan/Enter Audited Batch ID</label>
            <input type="text" id="source-batch-id" placeholder="e.g., FR123-20250908" required>
          </div>
          <div class="form-group">
            <label for="processing-date">Processing Date</label>
            <input type="date" id="processing-date" required>
          </div>
          <div class="form-group">
            <label for="quantity-processed">Quantity Processed (kg)</label>
            <input type="number" id="quantity-processed" min="0" step="0.1" placeholder="e.g., 95" required>
          </div>
          <div class="form-group">
            <label for="wastage">Wastage (kg)</label>
            <input type="number" id="wastage" min="0" step="0.1" placeholder="e.g., 5" required>
          </div>
          <div class="form-group">
            <label for="product-type">Final Product Type</label>
            <select id="product-type">
              <option>Rice Bag 25kg</option>
              <option>Powder Pack 1kg</option>
              <option>Herbal Oil Bottle</option>
            </select>
          </div>
          <div class="form-group">
            <label for="expiry-date">Expiry Date</label>
            <input type="date" id="expiry-date" required>
          </div>
          <button type="submit" class="submit-btn" id="submit-btn">Generate Product Batch + Update Blockchain</button>
          <p id="status-message"></p>
        </form>
      </div>

      <div class="card">
        <h3 class="card-header">Product History</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Product ID</th>
                <th>Source Batch</th>
                <th>Product</th>
                <th>Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="history-table-body">
              <tr class="placeholder">
                <td colspan="5">No products have been created yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const contractAddress = "YOUR_CONTRACT_ADDRESS_HERE";
      const contractABI = [ /* PASTE_YOUR_FULL_ABI_ARRAY_HERE */];

      const form = document.getElementById('process-form');
      const submitBtn = document.getElementById('submit-btn');
      const statusMessage = document.getElementById('status-message');
      const historyTableBody = document.getElementById('history-table-body');

      let contract, signer;

      async function init() {
        if (typeof window.ethereum === 'undefined') {
          statusMessage.innerText = "Please install MetaMask!";
          submitBtn.disabled = true;
          return;
        }

        try {
          const provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
          contract = new ethers.Contract(contractAddress, contractABI, signer);
          console.log("Connected to wallet and contract loaded.");
        } catch (error) {
          console.error("Initialization failed:", error);
          statusMessage.innerText = "Could not connect to wallet.";
          submitBtn.disabled = true;
        }
      }

      async function handleFormSubmit(event) {
        event.preventDefault();
        if (!contract || !signer) {
          statusMessage.innerText = "Please connect your wallet first.";
          return;
        }

        submitBtn.disabled = true;
        statusMessage.innerText = "Processing... Please confirm transaction in MetaMask.";

        try {
          const sourceBatchId = document.getElementById('source-batch-id').value;
          const productType = document.getElementById('product-type').value;
          const quantityProcessed = document.getElementById('quantity-processed').value;
          const wastage = document.getElementById('wastage').value;
          const processingDateVal = document.getElementById('processing-date').value;
          const expiryDateVal = document.getElementById('expiry-date').value;

          if (!sourceBatchId || !processingDateVal || !expiryDateVal || !quantityProcessed || !wastage) {
            throw new Error("Please fill out all required fields.");
          }

          const processingDate = Math.floor(new Date(processingDateVal).getTime() / 1000);
          const expiryDate = Math.floor(new Date(expiryDateVal).getTime() / 1000);
          const productId = `MF-${Date.now()}`;
          const manufacturerId = await signer.getAddress();
          const tx = await contract.createProduct(
            productId,
            sourceBatchId,
            productType,
            ethers.utils.parseUnits(quantityProcessed, 0),
            ethers.utils.parseUnits(wastage, 0),
            processingDate,
            expiryDate,
            manufacturerId
          );

          statusMessage.innerText = "Transaction sent... waiting for confirmation.";
          await tx.wait();

          statusMessage.innerText = `Success! Product ${productId} created.`;
          addProductToTable({
            productId,
            sourceBatchId,
            productType,
            date: new Date(processingDate * 1000).toLocaleDateString('en-GB'),
            status: "In Storage"
          });
          form.reset();

        } catch (error) {
          console.error("Transaction failed:", error);
          statusMessage.innerText = error.message.includes("User denied") ? "Transaction rejected." : "Transaction failed. Check console.";
        } finally {
          submitBtn.disabled = false;
          setTimeout(() => { statusMessage.innerText = ''; }, 5000);
        }
      }

      function addProductToTable(data) {
        const placeholder = historyTableBody.querySelector('.placeholder');
        if (placeholder) {
          placeholder.style.display = 'none';
        }

        const newRow = document.createElement('tr');
        newRow.innerHTML = `
                    <td>${data.productId}</td>
                    <td>${data.sourceBatchId}</td>
                    <td>${data.productType}</td>
                    <td>${data.date}</td>
                    <td><span class="status status-storage">${data.status}</span></td>
                `;
        historyTableBody.prepend(newRow);
      }

      form.addEventListener('submit', handleFormSubmit);
      init();
    });
  </script>
  <script>
  // Minimal auth guard for manufacturer; leave UI intact
  (function(){
    const targetRole = 'manufacturer';
    let user = null;
    try { user = JSON.parse(localStorage.getItem('ayurtrace_user') || 'null'); } catch(_) {}
    if (!user || !user.role) { window.location.href = '../login.html'; return; }
    const map = { farmer: 'farmer.html', collector: 'collector.html', manufacturer: 'manufacturer_dash.html', auditor: 'auditor.html' };
    if (user.role !== targetRole) {
      const t = map[user.role];
      window.location.href = t ? t : '../login.html';
      return;
    }
    // Point logout links to logout page if any exist
    document.querySelectorAll('a').forEach(a => { if (/logout/i.test(a.textContent)) a.href = '../logout.html'; });
  })();
  </script>
</body>

</html>
